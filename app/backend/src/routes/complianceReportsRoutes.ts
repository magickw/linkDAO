/**
 * Compliance Reports API Routes
 * 
 * REST API endpoints for generating and managing compliance reports.
 */

import { Router } from 'express';
import { body, param, query } from 'express-validator';
import { complianceReportsService } from '../services/complianceReportsService';
import { logger } from '../utils/logger';

const router = Router();

/**
 * Generate compliance summary report
 * POST /api/compliance/reports/summary
 */
router.post('/summary', [
  body('startDate').isISO8601().withMessage('Start date is required'),
  body('endDate').isISO8601().withMessage('End date is required'),
  body('generatedBy').notEmpty().withMessage('Generated by is required'),
  body('includeTrends').optional().isBoolean(),
  body('includePredictions').optional().isBoolean(),
  body('format').optional().isIn(['json', 'csv', 'pdf']).withMessage('Invalid format')
], async (req: any, res: any) => {
  try {
    const errors = req.validationErrors();
    if (errors.length > 0) {
      return res.status(400).json({
        error: 'Validation failed',
        details: errors
      });
    }

    const { startDate, endDate, generatedBy, includeTrends, includePredictions, format } = req.body;

    const report = await complianceReportsService.generateSummaryReport(
      new Date(startDate),
      new Date(endDate),
      {
        includeTrends,
        includePredictions,
        format: format || 'json',
        generatedBy
      }
    );

    res.status(201).json({
      success: true,
      data: report
    });
  } catch (error) {
    logger.error('Error generating summary report:', error);
    res.status(500).json({
      error: 'Failed to generate summary report',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * Generate violation report
 * POST /api/compliance/reports/violations
 */
router.post('/violations', [
  body('startDate').isISO8601().withMessage('Start date is required'),
  body('endDate').isISO8601().withMessage('End date is required'),
  body('generatedBy').notEmpty().withMessage('Generated by is required'),
  body('severity').optional().isArray(),
  body('type').optional().isArray(),
  body('includeResolved').optional().isBoolean(),
  body('format').optional().isIn(['json', 'csv', 'pdf']).withMessage('Invalid format')
], async (req: any, res: any) => {
  try {
    const errors = req.validationErrors();
    if (errors.length > 0) {
      return res.status(400).json({
        error: 'Validation failed',
        details: errors
      });
    }

    const { startDate, endDate, generatedBy, severity, type, includeResolved, format } = req.body;

    const report = await complianceReportsService.generateViolationReport(
      new Date(startDate),
      new Date(endDate),
      {
        severity,
        type,
        includeResolved,
        format: format || 'json',
        generatedBy
      }
    );

    res.status(201).json({
      success: true,
      data: report
    });
  } catch (error) {
    logger.error('Error generating violation report:', error);
    res.status(500).json({
      error: 'Failed to generate violation report',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * Generate trend analysis report
 * POST /api/compliance/reports/trends
 */
router.post('/trends', [
  body('startDate').isISO8601().withMessage('Start date is required'),
  body('endDate').isISO8601().withMessage('End date is required'),
  body('generatedBy').notEmpty().withMessage('Generated by is required'),
  body('includePredictions').optional().isBoolean(),
  body('forecastPeriod').optional().isInt({ min: 1, max: 365 }).withMessage('Forecast period must be between 1 and 365 days'),
  body('metrics').optional().isArray(),
  body('format').optional().isIn(['json', 'csv', 'pdf']).withMessage('Invalid format')
], async (req: any, res: any) => {
  try {
    const errors = req.validationErrors();
    if (errors.length > 0) {
      return res.status(400).json({
        error: 'Validation failed',
        details: errors
      });
    }

    const { startDate, endDate, generatedBy, includePredictions, forecastPeriod, metrics, format } = req.body;

    const report = await complianceReportsService.generateTrendReport(
      new Date(startDate),
      new Date(endDate),
      {
        includePredictions,
        forecastPeriod,
        metrics,
        format: format || 'json',
        generatedBy
      }
    );

    res.status(201).json({
      success: true,
      data: report
    });
  } catch (error) {
    logger.error('Error generating trend report:', error);
    res.status(500).json({
      error: 'Failed to generate trend report',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * Generate seller-specific report
 * POST /api/compliance/reports/seller/:sellerId
 */
router.post('/seller/:sellerId', [
  param('sellerId').notEmpty().withMessage('Seller ID is required'),
  body('startDate').isISO8601().withMessage('Start date is required'),
  body('endDate').isISO8601().withMessage('End date is required'),
  body('generatedBy').notEmpty().withMessage('Generated by is required'),
  body('includeHistory').optional().isBoolean(),
  body('includeViolations').optional().isBoolean(),
  body('includeMetrics').optional().isBoolean(),
  body('format').optional().isIn(['json', 'csv', 'pdf']).withMessage('Invalid format')
], async (req: any, res: any) => {
  try {
    const errors = req.validationErrors();
    if (errors.length > 0) {
      return res.status(400).json({
        error: 'Validation failed',
        details: errors
      });
    }

    const { sellerId } = req.params;
    const { startDate, endDate, generatedBy, includeHistory, includeViolations, includeMetrics, format } = req.body;

    const report = await complianceReportsService.generateSellerReport(
      sellerId,
      new Date(startDate),
      new Date(endDate),
      {
        includeHistory,
        includeViolations,
        includeMetrics,
        format: format || 'json',
        generatedBy
      }
    );

    res.status(201).json({
      success: true,
      data: report
    });
  } catch (error) {
    logger.error('Error generating seller report:', error);
    res.status(500).json({
      error: 'Failed to generate seller report',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * Get report by ID
 * GET /api/compliance/reports/:reportId
 */
router.get('/:reportId', [
  param('reportId').notEmpty().withMessage('Report ID is required')
], async (req: any, res: any) => {
  try {
    const errors = req.validationErrors();
    if (errors.length > 0) {
      return res.status(400).json({
        error: 'Validation failed',
        details: errors
      });
    }

    const { reportId } = req.params;
    const report = await complianceReportsService.getReport(reportId);

    if (!report) {
      return res.status(404).json({
        error: 'Report not found',
        message: `Report with ID ${reportId} not found`
      });
    }

    res.json({
      success: true,
      data: report
    });
  } catch (error) {
    logger.error('Error getting report:', error);
    res.status(500).json({
      error: 'Failed to get report',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * Get reports list
 * GET /api/compliance/reports
 */
router.get('/', [
  query('type').optional().isIn(['summary', 'violation', 'trend', 'seller', 'custom']).withMessage('Invalid report type'),
  query('startDate').optional().isISO8601(),
  query('endDate').optional().isISO8601(),
  query('generatedBy').optional().isString(),
  query('limit').optional().isInt({ min: 1, max: 100 }).withMessage('Limit must be between 1 and 100'),
  query('offset').optional().isInt({ min: 0 }).withMessage('Offset must be non-negative')
], async (req: any, res: any) => {
  try {
    const errors = req.validationErrors();
    if (errors.length > 0) {
      return res.status(400).json({
        error: 'Validation failed',
        details: errors
      });
    }

    const { type, startDate, endDate, generatedBy, limit, offset } = req.query;

    const filters: any = {};
    if (type) filters.type = type;
    if (startDate) filters.startDate = new Date(startDate);
    if (endDate) filters.endDate = new Date(endDate);
    if (generatedBy) filters.generatedBy = generatedBy;
    if (limit) filters.limit = parseInt(limit);
    if (offset) filters.offset = parseInt(offset);

    const reports = await complianceReportsService.getReports(filters);

    res.json({
      success: true,
      data: reports
    });
  } catch (error) {
    logger.error('Error getting reports:', error);
    res.status(500).json({
      error: 'Failed to get reports',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * Delete report
 * DELETE /api/compliance/reports/:reportId
 */
router.delete('/:reportId', [
  param('reportId').notEmpty().withMessage('Report ID is required')
], async (req: any, res: any) => {
  try {
    const errors = req.validationErrors();
    if (errors.length > 0) {
      return res.status(400).json({
        error: 'Validation failed',
        details: errors
      });
    }

    const { reportId } = req.params;

    // Check if report exists
    const report = await complianceReportsService.getReport(reportId);
    if (!report) {
      return res.status(404).json({
        error: 'Report not found',
        message: `Report with ID ${reportId} not found`
      });
    }

    await complianceReportsService.deleteReport(reportId);

    res.json({
      success: true,
      message: 'Report deleted successfully'
    });
  } catch (error) {
    logger.error('Error deleting report:', error);
    res.status(500).json({
      error: 'Failed to delete report',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * Get report statistics
 * GET /api/compliance/reports/stats
 */
router.get('/stats', async (req: any, res: any) => {
  try {
    const stats = complianceReportsService.getReportStats();

    res.json({
      success: true,
      data: stats
    });
  } catch (error) {
    logger.error('Error getting report statistics:', error);
    res.status(500).json({
      error: 'Failed to get report statistics',
      message: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

export default router;