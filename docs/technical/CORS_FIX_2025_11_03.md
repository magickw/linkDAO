# CORS Configuration Fix - November 3, 2025

## Issue

**Symptoms**: Backend returning CORS errors, blocking all frontend requests
```
Error: Not allowed by CORS
    at origin (/opt/render/project/src/app/backend/src/index.production.optimized.js:205:18)
```

**Root Cause**: Production CORS configuration had `allowedOrigins: ['*']` which doesn't work with the callback-based origin validation. The `'*'` string was being checked literally, not as a wildcard.

---

## Solution Applied

### 1. Fixed Production Allowed Origins

**File**: `app/backend/src/middleware/corsMiddleware.ts:58-65`

Changed from:
```javascript
production: {
  allowedOrigins: ['*'],  // ❌ Doesn't work with callback validation
```

To:
```javascript
production: {
  allowedOrigins: [
    'https://www.linkdao.io',
    'https://linkdao.io',
    'https://linkdao-frontend.vercel.app',
    'https://linkdao-frontend-*.vercel.app', // Vercel preview deployments
    'https://*.vercel.app'                     // All Vercel apps
  ],
```

### 2. Added Wildcard Pattern Support

**File**: `app/backend/src/middleware/corsMiddleware.ts:181-196`

Added regex-based wildcard matching:
```javascript
// Check for wildcard patterns (e.g., *.vercel.app)
const isWildcardMatch = this.config.allowedOrigins.some(allowed => {
  if (allowed.includes('*')) {
    // Convert wildcard pattern to regex
    const pattern = allowed
      .replace(/\./g, '\\.')
      .replace(/\*/g, '.*');
    const regex = new RegExp(`^${pattern}$`);
    return regex.test(origin);
  }
  return false;
});

if (isWildcardMatch) {
  return callback(null, true);
}
```

---

## Environment Variable Configuration

You can also configure CORS origins via environment variables without code changes:

### Option 1: Single Domain
```bash
CORS_ORIGIN=https://www.linkdao.io
```

### Option 2: Multiple Domains (Comma-Separated)
```bash
CORS_ORIGIN=https://www.linkdao.io,https://linkdao.io,https://app.linkdao.io
```

### Option 3: Using Alternative Variable Name
```bash
CORS_ALLOWED_ORIGINS=https://www.linkdao.io,https://linkdao.io
```

The middleware automatically adds these to the allowed list (see line 150-151).

---

## Deployment Steps

### 1. Render Environment Variables (Recommended)

1. Go to Render Dashboard: https://dashboard.render.com
2. Select `linkdao-backend` service
3. Navigate to "Environment" tab
4. Add new environment variable:
   ```
   Key: CORS_ORIGIN
   Value: https://www.linkdao.io,https://linkdao.io
   ```
5. Save changes (will trigger auto-deploy)

### 2. Code Deployment (Already Done)

The code changes are complete and will work immediately after deployment.

---

## Verification

### Test CORS is Working

```bash
# Test from command line
curl -H "Origin: https://www.linkdao.io" \
  -H "Access-Control-Request-Method: GET" \
  -X OPTIONS \
  https://linkdao-backend.onrender.com/health

# Should return:
# Access-Control-Allow-Origin: https://www.linkdao.io
# Access-Control-Allow-Credentials: true
```

### Check Frontend

After deployment, check browser console:
- ✅ No more "Not allowed by CORS" errors
- ✅ API requests succeed from www.linkdao.io
- ✅ Analytics, feed, and follow endpoints work

---

## Security Considerations

### Why Not Use `origin: '*'`?

While `origin: '*'` allows all origins, it:
1. ❌ Cannot be used with `credentials: true`
2. ❌ Opens up to CSRF attacks
3. ❌ Allows any website to call your API
4. ❌ Breaks authentication cookies

### Current Security Posture

✅ Only allows specific trusted domains
✅ Supports credentials and cookies
✅ Logs blocked origins for monitoring
✅ Protects against CSRF attacks
✅ Allows preview deployments via wildcards

---

## Allowed Domains After Fix

| Domain Pattern | Purpose | Example Match |
|---------------|---------|---------------|
| `https://www.linkdao.io` | Production website | Exact match |
| `https://linkdao.io` | Production (no www) | Exact match |
| `https://linkdao-frontend.vercel.app` | Main Vercel deployment | Exact match |
| `https://linkdao-frontend-*.vercel.app` | Preview deployments | `linkdao-frontend-abc123.vercel.app` |
| `https://*.vercel.app` | All Vercel apps | Any Vercel subdomain |

---

## Adding New Domains

### Via Environment Variable (No Code Change)
```bash
# In Render dashboard, add to CORS_ORIGIN:
CORS_ORIGIN=https://www.linkdao.io,https://linkdao.io,https://new-domain.com
```

### Via Code (Requires Deployment)
Edit `app/backend/src/middleware/corsMiddleware.ts:59-65`:
```javascript
production: {
  allowedOrigins: [
    'https://www.linkdao.io',
    'https://linkdao.io',
    'https://new-domain.com',  // Add here
    // ... existing domains
  ],
```

---

## Troubleshooting

### Still Getting CORS Errors?

1. **Check Origin in Logs**
   ```bash
   # Look for "CORS origin blocked" in Render logs
   # It will show the exact origin being rejected
   ```

2. **Verify Environment Variable**
   ```bash
   # In Render dashboard, check Environment tab
   # Ensure CORS_ORIGIN is set correctly
   ```

3. **Check Origin Format**
   - ✅ Use: `https://www.linkdao.io` (with protocol, no trailing slash)
   - ❌ Don't use: `www.linkdao.io` (missing protocol)
   - ❌ Don't use: `https://www.linkdao.io/` (trailing slash)

4. **Clear Browser Cache**
   - CORS preflight responses are cached
   - Hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)

### Testing Specific Origins

```javascript
// Temporarily add to corsMiddleware.ts for debugging
logger.info('CORS check', {
  origin,
  allowed: this.config.allowedOrigins,
  matches: this.config.allowedOrigins.includes(origin)
});
```

---

## Monitoring

### Check CORS Errors in Logs

```bash
# In Render logs, search for:
"CORS origin blocked"

# This will show:
# - Which origins are being rejected
# - Timestamp of rejection
# - Current allowed origins list
```

### Alert on Unexpected CORS Blocks

If you see CORS blocks from legitimate domains, add them immediately via:
1. Environment variable (fastest, no deploy)
2. Code change (more permanent)

---

## Related Files

- `app/backend/src/middleware/corsMiddleware.ts` - Main CORS configuration
- `app/backend/src/index.ts:202` - CORS middleware application
- `docs/operations/TROUBLESHOOTING_GUIDE.md` - General troubleshooting

---

## Rollback Plan

If CORS fix causes issues:

### Quick Rollback (Temporary - NOT RECOMMENDED FOR PRODUCTION)
Set environment variable to allow all origins temporarily:
```bash
# In Render dashboard, add:
CORS_ORIGIN=*

# Then modify code to handle this special case
```

### Proper Rollback
Revert to previous Git commit before this change.

---

**Status**: ✅ FIXED
**Deployed**: Pending (automatic on Git push)
**Priority**: P0 - Critical (blocks all frontend functionality)
**Impact**: All frontend API calls will work after deployment
